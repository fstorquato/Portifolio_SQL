
# PROBLEMA 
## ATUAL CATEGORIZAÇÃO DE CLIENTES (GRUPOS A,B,C e D) NÃO CORRESPONDEM A UMA REALIDADE LÓGICA E FORAM DEFINIDOS MANUALMENTE.

### SOLUÇÃO - CRIAR UMA CATEGORIZAÇÃO DINÂMICA USANDO OS CRITÉRIOS DE RFV:

```
    R - RECÊNCIA: QTD DE DIAS DA ÚLTIMA COMPRA
          5   < 30 dias
          4   31 e 60 dias
          3   60 e 120 dias
          2   120 e 240 dias
          1   240 e 365 dias
          0   > 365 dias
    F - FREQUÊNCIA: QTD MESES COM COMPRAS ULTIMOS 12 MESES
          5   12 meses
          4   10 ou 11 meses
          3   6 a 9 meses
          2   2 a 5 meses
          1   1 mês
          0   0 mês
    v - QTD DE KG ACUMULADOS NOS ULTIMOS 12 MESES
          5   > 600 kg
          4   300 a 600 kg
          3   150 a 300 kg
          2   75 a 150 kg
          1   < 75 kg
          0   0 kg
```

### Modelo de arquivo importado em *.csv

```
DATA,COD_CLIENTE,GRUPO,CIDADE,UF,ROTA,CARGA,NOTA_FISCAL,VALOR_NF,ID_VENDEDOR,ID_VEICULO,SEGMENTO,FILIAL,ID_MOTORISTA,PAGTO,PAGTO_DIAS,PESO_KG,ANO,MES
2018-01-01,6024,A,"MONTE SIAO",MG,"MOGI GUACU",1033192,5248239,978.04,179,1051,SUPERMERCADOS,"SAO CARLOS",551,BOLETO,"14 DDL",54.3,2018,1
2018-01-01,65076,D,PROMISSAO,SP,PENAPOLIS,1033200,5247375,2676.35,191,1030,SUPERMERCADOS,MARILIA,530,BOLETO,"14 DDL",148.7,2018,1
2018-01-01,24322,B,BAURU,SP,BAURU,1033664,5251902,941.58,195,1053,RESTAURANTES,"SAO CARLOS",553,BOLETO,"14 DDL",52.3,2018,1
2018-01-01,69452,D,VOTORANTIM,SP,SOROCABA,1033792,5250315,142.02,148,1052,SUPERMERCADOS,JUNDIAI,552,BOLETO,"14 DDL",7.9,2018,1
2018-01-01,69452,D,VOTORANTIM,SP,SOROCABA,1033792,5250318,18676.5,148,1052,SUPERMERCADOS,JUNDIAI,552,BOLETO,"14 DDL",1037.6,2018,1
```

### Query desenvolvida

```
SET @data_base = '2021-12-31';

SELECT 
    @data_base DATA_RELAT, DATA DATA_VENDA, COD_CLIENTE, CIDADE, UF, ROTA, CARGA, NOTA_FISCAL, VALOR_NF, ID_VENDEDOR, ID_VEICULO, SEGMENTO, FILIAL, ID_MOTORISTA, PAGTO, PAGTO_DIAS, PESO_KG,
    TR.RECENCIA AS RECENCIA, IFNULL(TF.FREQUENCIA,0) AS FREQUENCIA, IFNULL(TK.KG_ACUM, 0) AS KG_ACUM
 FROM port01.tb_fvendas TV
 # Query para nomear as Recências
 LEFT JOIN (
    SELECT CLIENTE,
        CASE
            WHEN DIF_DIAS >= 0 AND DIF_DIAS <= 30 THEN 5
            WHEN DIF_DIAS > 30 AND DIF_DIAS <= 60 THEN 4
            WHEN DIF_DIAS > 60 AND DIF_DIAS <= 120 THEN 3
            WHEN DIF_DIAS > 120 AND DIF_DIAS <= 240 THEN 2
            WHEN DIF_DIAS > 240 AND DIF_DIAS <= 365 THEN 1
            ELSE 0
        END AS RECENCIA
    FROM
    (SELECT DISTINCT 
        t1.COD_CLIENTE AS CLIENTE,
        @data_base AS DATA_ATUAL,
        t1.DATA AS DATA_ULT_COMPRA,
        DATEDIFF(@data_base, t1.DATA) AS DIF_DIAS
    FROM port01.tb_fvendas t1
    JOIN (
        SELECT 
            COD_CLIENTE, 
            MAX(DATA) AS ultima_data 
        FROM port01.tb_fvendas
        WHERE DATA <= @data_base
        GROUP BY COD_CLIENTE) t2 
    ON t1.COD_CLIENTE = t2.COD_CLIENTE AND t1.DATA = t2.ultima_data
    ORDER BY DATA DESC) TBR) TR 
ON TV.COD_CLIENTE = TR.CLIENTE
# Query para nomear as Frequências
LEFT JOIN (
    SELECT
        CLIENT2 CLIENTE,
        CASE 
            WHEN VENDAS2 >= 0 AND VENDAS2 < 2 THEN 1
            WHEN VENDAS2 >= 2 AND VENDAS2 < 6 THEN 2
            WHEN VENDAS2 >= 6 AND VENDAS2 < 10 THEN 3
            WHEN VENDAS2 >= 10 AND VENDAS2 < 12 THEN 4
            WHEN VENDAS2 >= 12 THEN 5
            ELSE 0
        END FREQUENCIA
    FROM (
    SELECT
        CLIENT1 CLIENT2,
        COUNT(MES1) VENDAS2
    FROM(    
    SELECT DISTINCT
        CLIENT1,
        ANO1,
        MES1
    FROM
        (
        SELECT 
            COD_CLIENTE CLIENT1,
            YEAR(DATA) ANO1,
            MONTH(DATA) MES1
        FROM port01.tb_fvendas
        WHERE data BETWEEN DATE_SUB(@data_base, INTERVAL 1 YEAR) AND @data_base
        ORDER BY COD_CLIENTE, DATA DESC) TBF1
    ORDER BY CLIENT1, ANO1 DESC, MES1 DESC) TBF2
    GROUP BY CLIENT1) TBF3) TF 
ON TV.COD_CLIENTE = TF.CLIENTE
# Query para nomear KG acumulados últimos 12 meses
LEFT JOIN(
    SELECT
        CLIENT4 CLIENTE,
        CASE
            WHEN KG_ACUM1 > 0 AND KG_ACUM1 <= 75 THEN 1
            WHEN KG_ACUM1 > 75 AND KG_ACUM1 <= 150 THEN 2
            WHEN KG_ACUM1 > 150 AND KG_ACUM1 <= 300 THEN 3
            WHEN KG_ACUM1 > 300 AND KG_ACUM1 <= 600 THEN 4
            WHEN KG_ACUM1 > 600 THEN 5
            ELSE 0
        END KG_ACUM
    FROM(
    SELECT
        COD_CLIENTE CLIENT4,
        ROUND(SUM(PESO_KG),1) KG_ACUM1
    FROM port01.tb_fvendas
    WHERE data BETWEEN DATE_SUB(@data_base, INTERVAL 1 YEAR) AND @data_base
    GROUP BY COD_CLIENTE
    ORDER BY COD_CLIENTE) TBV
    ORDER BY CLIENTE) TK 
ON TV.COD_CLIENTE = TK.CLIENTE
WHERE DATA <= @data_base
ORDER BY DATA_VENDA;
```

### Saída

```
DATA_RELAT,DATA_VENDA,COD_CLIENTE,CIDADE,UF,ROTA,CARGA,NOTA_FISCAL,VALOR_NF,ID_VENDEDOR,ID_VEICULO,SEGMENTO,FILIAL,ID_MOTORISTA,PAGTO,PAGTO_DIAS,PESO_KG,RECENCIA,FREQUENCIA,KG_ACUM
2021-12-31,2018-01-01,6024,"MONTE SIAO",MG,"MOGI GUACU",1033192,5248239,978.04,179,1051,SUPERMERCADOS,"SAO CARLOS",551,BOLETO,"14 DDL",54.3,0,0,0
2021-12-31,2018-01-01,65076,PROMISSAO,SP,PENAPOLIS,1033200,5247375,2676.35,191,1030,SUPERMERCADOS,MARILIA,530,BOLETO,"14 DDL",148.7,5,3,4
2021-12-31,2018-01-01,69452,VOTORANTIM,SP,SOROCABA,1033792,5250321,493.1,148,1052,SUPERMERCADOS,JUNDIAI,552,BOLETO,"14 DDL",27.4,5,3,5
2021-12-31,2018-01-01,69452,VOTORANTIM,SP,SOROCABA,1033792,5250315,142.02,148,1052,SUPERMERCADOS,JUNDIAI,552,BOLETO,"14 DDL",7.9,5,3,5
2021-12-31,2018-01-01,69452,VOTORANTIM,SP,SOROCABA,1033792,5250318,18676.5,148,1052,SUPERMERCADOS,JUNDIAI,552,BOLETO,"14 DDL",1037.6,5,3,5
2021-12-31,2018-01-01,24322,BAURU,SP,BAURU,1033664,5251902,941.58,195,1053,RESTAURANTES,"SAO CARLOS",553,BOLETO,"14 DDL",52.3,2,3,5
2021-12-31,2018-01-02,25872,CAMPINAS,SP,CAMPINAS,1033240,5247903,470.79,117,1060,BARES,JUNDIAI,524,BOLETO,"14 DDL",26.2,2,2,2
2021-12-31,2018-01-02,18806,"RIO CLARO",SP,"RIO CLARO",1033252,5248482,479.34,182,1042,SUPERMERCADOS,"SAO CARLOS",542,DEPOSITO,ANT,26.6,2,3,3
2021-12-31,2018-01-02,36748,UBERLANDIA,MG,UBERABA,1033260,5247843,432.99,151,1033,RESTAURANTES,UBERLANDIA,533,BOLETO,"14 DDL",24.1,3,2,2
2021-12-31,2018-01-02,38240,ARAPONGAS,PR,LONDRINA,1033520,5249325,457.37,111,1068,SUPERMERCADOS,LONDRINA,568,DEPOSITO,ANT,25.4,3,2,3
```

## Conforme a operação for alimentando o sistema ERP ou CRM, as colunas 'RECENCIA', 'FREQUENCIA' e 'KG_ACUM' serão atualizadas e a consequência será a reclassificação dos clientes.
