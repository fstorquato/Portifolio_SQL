# PROBLEMA
## Formatar base de dados para desenvolver uma análise de Churn
### Considerar Churn clientes que não compram há mais de 6 meses

Exemplo do arquivo *.csv para importação
```
DATA,COD_CLIENTE,GRUPO,CIDADE,UF,ROTA,CARGA,NOTA_FISCAL,VALOR_NF,ID_VENDEDOR,ID_VEICULO,SEGMENTO,FILIAL,ID_MOTORISTA,PAGTO,PAGTO_DIAS,PESO_KG,ANO,MES
2018-01-01,6024,A,"MONTE SIAO",MG,"MOGI GUACU",1033192,5248239,978.04,179,1051,SUPERMERCADOS,"SAO CARLOS",551,BOLETO,"14 DDL",54.3,2018,1
2018-01-01,65076,D,PROMISSAO,SP,PENAPOLIS,1033200,5247375,2676.35,191,1030,SUPERMERCADOS,MARILIA,530,BOLETO,"14 DDL",148.7,2018,1
2018-01-01,24322,B,BAURU,SP,BAURU,1033664,5251902,941.58,195,1053,RESTAURANTES,"SAO CARLOS",553,BOLETO,"14 DDL",52.3,2018,1
2018-01-01,69452,D,VOTORANTIM,SP,SOROCABA,1033792,5250315,142.02,148,1052,SUPERMERCADOS,JUNDIAI,552,BOLETO,"14 DDL",7.9,2018,1
2018-01-01,69452,D,VOTORANTIM,SP,SOROCABA,1033792,5250318,18676.5,148,1052,SUPERMERCADOS,JUNDIAI,552,BOLETO,"14 DDL",1037.6,2018,1
2018-01-01,69452,D,VOTORANTIM,SP,SOROCABA,1033792,5250321,493.1,148,1052,SUPERMERCADOS,JUNDIAI,552,BOLETO,"14 DDL",27.4,2018,1


## Query para saída dp resultado

```
SET @data_base = '2021-12-31';

SELECT *,
    ROUND(KG_ACUM / QTD_VENDA,1) AS KG_VENDA,
    IFNULL(ROUND(QTD_VENDA / MESES_COMPRANDO,1), QTD_VENDA) AS VENDA_MES,
    CASE
        WHEN MESES_SEM_COMPRAR > 6 THEN 1
        ELSE 0
    END AS CHURN
FROM(
SELECT DISTINCT 
    t1.COD_CLIENTE AS CLIENTE, t2.SEGMENTO AS SEGMENTO, t2.FILIAL AS FILIAL, t2.ROTA AS ROTA, t2.CIDADE AS CIDADE, t2.UF AS UF, 
    t2.QTD_VENDA AS QTD_VENDA,t2.KG_ACUM AS KG_ACUM, 
    @data_base AS DATA_ATUAL,
    t1.DATA AS DATA_ULT_COMPRA,   
    DATEDIFF(@data_base, t1.DATA) AS DIF_DIAS_ULT,
    t2.pima_data AS DATA_PRI_COMPRA,
    DATEDIFF(@data_base, t2.pima_data) AS DIF_DIAS_PRI,
    (DATEDIFF(@data_base, t2.pima_data) - DATEDIFF(@data_base, t1.DATA)) DIV 30.4 AS MESES_COMPRANDO,
    (DATEDIFF(@data_base, t1.DATA)) DIV 30.4 MESES_SEM_COMPRAR
FROM port01.tb_fvendas t1
JOIN (
    SELECT 
        COD_CLIENTE, SEGMENTO, FILIAL, ROTA, CIDADE, UF,
        COUNT(NOTA_FISCAL) QTD_VENDA,
        ROUND(SUM(PESO_KG),1) KG_ACUM,
        MAX(DATA) AS ultima_data,
        MIN(DATA) AS pima_data
    FROM port01.tb_fvendas
    WHERE DATA <= @data_base
    GROUP BY COD_CLIENTE, SEGMENTO, FILIAL, ROTA, CIDADE, UF) t2 
ON t1.COD_CLIENTE = t2.COD_CLIENTE AND t1.DATA = t2.ultima_data
ORDER BY DATA DESC) TCH
ORDER BY DATA_ULT_COMPRA DESC, CLIENTE;
```

## Resuldado da Query
```
CLIENTE,SEGMENTO,FILIAL,ROTA,CIDADE,UF,QTD_VENDA,KG_ACUM,DATA_ATUAL,DATA_ULT_COMPRA,DIF_DIAS_ULT,DATA_PRI_COMPRA,DIF_DIAS_PRI,MESES_COMPRANDO,MESES_SEM_COMPRAR,KG_VENDA,VENDA_MES,CHURN
10086,SUPERMERCADOS,"SAO CARLOS",ARARAQUARA,MATAO,SP,103,5658.7,2021-12-31,2021-12-31,0,2018-01-04,1457,47,0,54.9,2.2,0
102788,CONVENIÊNCIA,"SAO CARLOS",ARAXA,MIGUELOPOLIS,SP,27,1097.9,2021-12-31,2021-12-31,0,2019-09-05,848,27,0,40.7,1.0,0
104890,PIZZARIAS,"SAO CARLOS",ARAXA,ARAXA,MG,9,247.2,2021-12-31,2021-12-31,0,2020-01-21,710,23,0,27.5,0.4,0
121698,SUPERMERCADOS,"SAO CARLOS",ARAXA,ARAXA,MG,1,60.4,2021-12-31,2021-12-31,0,2021-12-31,0,0,0,60.4,1.0,0
17188,SUPERMERCADOS,"SAO JOSE DO RIO PRETO",CATANDUVA,MENDONCA,SP,70,5909.7,2021-12-31,2021-12-31,0,2018-01-08,1453,47,0,84.4,1.5,0
17564,PIZZARIAS,"SAO JOSE DO RIO PRETO",BARRETOS,OLIMPIA,SP,45,6695.3,2021-12-31,2021-12-31,0,2018-01-17,1444,47,0,148.8,1.0,0
32970,PADARIAS,"SAO CARLOS",FRANCA,JERIQUARA,SP,61,5162.3,2021-12-31,2021-12-31,0,2019-02-14,1051,34,0,84.6,1.8,0
5210,SUPERMERCADOS,"SAO CARLOS","SAO CARLOS",IBATE,SP,332,11726.6,2021-12-31,2021-12-31,0,2018-01-04,1457,47,0,35.3,7.1,0
```
